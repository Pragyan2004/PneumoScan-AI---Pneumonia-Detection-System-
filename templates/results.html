{% extends "base.html" %}

{% block content %}
<section class="results-section">
    <div class="container">
        <div class="results-header">
            <div class="header-content">
                <h1 class="section-title">Analysis Results</h1>
                <p class="section-subtitle">AI-powered pneumonia detection analysis report</p>
                <div class="report-meta">
                    <span class="meta-item">
                        <strong>Report ID:</strong> 
                        <span id="reportId">PS-{{ "%08d" | format(range(10000000, 99999999) | random ) }}</span>
                    </span>
                    <span class="meta-item">
                        <strong>Generated:</strong> 
                        <span id="reportDate">{{ now.strftime('%Y-%m-%d %H:%M') if now else '' }}</span>
                    </span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="window.print()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <path d="M6 14h12v8H6z"/>
                    </svg>
                    Print Report
                </button>
                <button class="btn btn-secondary" id="shareBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                        <polyline points="16 6 12 2 8 6"/>
                        <line x1="12" y1="2" x2="12" y1="15"/>
                    </svg>
                    Export PDF
                </button>
            </div>
        </div>

        <div class="results-content">
            <div class="summary-card">
                <div class="summary-header">
                    <h2>Quick Summary</h2>
                    <div class="status-badge" id="overallStatus">
                        <span id="statusText">Analysis Complete</span>
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-label">Detection Result</span>
                        <span class="summary-value" id="detectionResult">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Confidence Level</span>
                        <span class="summary-value" id="confidenceLevel">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Analysis Time</span>
                        <span class="summary-value" id="analysisDuration">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Image Quality</span>
                        <span class="summary-value" id="imageQualityScore">-</span>
                    </div>
                </div>
            </div>
            <div class="results-grid">
                <div class="result-card image-card">
                    <div class="card-header">
                        <h3>X-Ray Image Analysis</h3>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="toggleImageEnhancement()" title="Enhance Image">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 8v8M8 12h8"/>
                                </svg>
                            </button>
                            <button class="btn-icon" onclick="resetImage()" title="Reset View">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                    <path d="M3 3v5h5"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="image-container">
                        <div class="image-wrapper">
                            <img id="resultImage" src="" alt="Analyzed X-Ray" class="xray-image">
                            <div class="image-overlay" id="imageOverlay">
                                <div class="enhancement-controls">
                                    <button class="btn-control" onclick="adjustBrightness(0.1)">+ Bright</button>
                                    <button class="btn-control" onclick="adjustBrightness(-0.1)">- Bright</button>
                                    <button class="btn-control" onclick="adjustContrast(0.1)">+ Contrast</button>
                                    <button class="btn-control" onclick="adjustContrast(-0.1)">- Contrast</button>
                                </div>
                            </div>
                        </div>
                        <div class="image-meta">
                            <div class="meta-item">
                                <span>Dimensions:</span>
                                <span id="imageDimensions">-</span>
                            </div>
                            <div class="meta-item">
                                <span>File Type:</span>
                                <span id="imageType">-</span>
                            </div>
                            <div class="meta-item">
                                <span>Processed:</span>
                                <span id="processedTime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-card analysis-card">
                    <div class="card-header">
                        <h3>AI Analysis Details</h3>
                        <div class="confidence-badge" id="confidenceBadge">
                            <span id="confidenceValue">0%</span>
                        </div>
                    </div>
                    
                    <div class="analysis-content">
                        <div class="confidence-visualization">
                            <div class="confidence-meter">
                                <div class="meter-background">
                                    <div class="meter-fill" id="meterFill"></div>
                                </div>
                                <div class="confidence-labels">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>
                            <div class="confidence-stats">
                                <div class="stat">
                                    <span class="stat-label">Pneumonia Probability</span>
                                    <span class="stat-value" id="pneumoniaProb">-</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Normal Probability</span>
                                    <span class="stat-value" id="normalProb">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="probability-chart">
                            <canvas id="probabilityChart"></canvas>
                        </div>

                        <div class="detailed-metrics">
                            <h4>Model Performance Metrics</h4>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">Model Accuracy</span>
                                    <span class="metric-value">94.2%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Precision</span>
                                    <span class="metric-value">92.8%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Recall</span>
                                    <span class="metric-value">95.1%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">F1-Score</span>
                                    <span class="metric-value">93.9%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="findings-section">
                <div class="findings-card">
                    <div class="card-header">
                        <h3>Clinical Findings & Recommendations</h3>
                        <div class="severity-indicator" id="severityIndicator">
                            <span id="severityText">-</span>
                        </div>
                    </div>
                    
                    <div class="findings-content">
                        <div class="finding-category" id="normalFindings">
                            <div class="finding-header positive">
                                <h4>✅ No Pneumonia Detected</h4>
                                <span class="finding-confidence">High Confidence</span>
                            </div>
                            <div class="finding-details">
                                <p><strong>Interpretation:</strong> The chest X-ray appears within normal limits with no significant findings suggestive of pneumonia.</p>
                                <div class="observation-list">
                                    <h5>Key Observations:</h5>
                                    <ul>
                                        <li>Clear lung fields bilaterally</li>
                                        <li>Normal pulmonary vasculature</li>
                                        <li>No focal consolidation</li>
                                        <li>Normal cardiac silhouette</li>
                                        <li>Clear costophrenic angles</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="finding-category" id="pneumoniaFindings">
                            <div class="finding-header warning">
                                <h4>⚠️ Pneumonia Indicators Detected</h4>
                                <span class="finding-confidence">Requires Review</span>
                            </div>
                            <div class="finding-details">
                                <p><strong>Interpretation:</strong> Findings suggestive of pulmonary consolidation consistent with pneumonia.</p>
                                <div class="observation-list">
                                    <h5>Key Observations:</h5>
                                    <ul>
                                        <li>Area of focal consolidation in right lower lobe</li>
                                        <li>Increased parenchymal opacity</li>
                                        <li>Air bronchograms present</li>
                                        <li>Blunted costophrenic angle</li>
                                        <li>Peribronchial thickening</li>
                                    </ul>
                                </div>
                                <div class="location-details">
                                    <h5>Affected Areas:</h5>
                                    <div class="location-tags">
                                        <span class="location-tag">Right Lower Lobe</span>
                                        <span class="location-tag">Left Upper Lobe</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="recommendations-box">
                            <h4>Clinical Recommendations</h4>
                            <div class="recommendations-content" id="recommendationsContent">
                                <div class="recommendation-item">
                                    <span class="rec-icon">👨‍⚕️</span>
                                    <span>Consult with a pulmonologist or infectious disease specialist</span>
                                </div>
                                <div class="recommendation-item">
                                    <span class="rec-icon">🩺</span>
                                    <span>Consider additional diagnostic tests if clinically indicated</span>
                                </div>
                                <div class="recommendation-item">
                                    <span class="rec-icon">💊</span>
                                    <span>Initiate appropriate antimicrobial therapy based on clinical findings</span>
                                </div>
                                <div class="recommendation-item">
                                    <span class="rec-icon">📊</span>
                                    <span>Monitor patient's respiratory status and vital signs closely</span>
                                </div>
                                <div class="recommendation-item">
                                    <span class="rec-icon">🔄</span>
                                    <span>Follow-up chest X-ray in 24-48 hours to assess progression</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="technical-section">
                <div class="technical-card">
                    <h3>Technical Details</h3>
                    <div class="technical-grid">
                        <div class="tech-item">
                            <span class="tech-label">Model Version</span>
                            <span class="tech-value">PneumoNet v2.5.1</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">AI Framework</span>
                            <span class="tech-value">TensorFlow 2.12 + Keras</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Architecture</span>
                            <span class="tech-value">Deep CNN with Attention</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Training Data</span>
                            <span class="tech-value">12,543 chest X-rays</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Processing Time</span>
                            <span class="tech-value" id="processingTime">-</span>
                        </div>
                        <div class="tech-item">
                            <span class="tech-label">Confidence Threshold</span>
                            <span class="tech-value">85%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-section">
                <div class="action-buttons">
                    <a href="{{ url_for('upload') }}" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Analyze Another Image
                    </a>
                    <button class="btn btn-secondary" onclick="downloadReport()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download Full Report
                    </button>
                    <button class="btn btn-outline" id="secondOpinionBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Get Second Opinion
                    </button>
                </div>
                
                <div class="disclaimer">
                    <p><strong>Disclaimer:</strong> This AI analysis is intended to assist healthcare professionals and should not replace clinical judgment. Always correlate with clinical findings, patient history, and other diagnostic tests. Final diagnosis should be made by a qualified medical professional.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal" id="loadingModal">
    <div class="modal-content">
        <div class="modal-icon loading">
            <div class="loading-spinner large"></div>
        </div>
        <h3>Generating Report</h3>
        <p>Preparing your comprehensive analysis report...</p>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
    </div>
</div>

<div class="modal" id="exportModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeExportModal()">&times;</span>
        <div class="modal-icon">📄</div>
        <h3>Export Report</h3>
        <p>Choose your preferred format:</p>
        <div class="export-options">
            <button class="export-option" onclick="exportPDF()">
                <span class="export-icon">📊</span>
                <span>PDF Report</span>
                <small>High quality, printable</small>
            </button>
            <button class="export-option" onclick="exportCSV()">
                <span class="export-icon">📋</span>
                <span>CSV Data</span>
                <small>Structured data</small>
            </button>
            <button class="export-option" onclick="exportJSON()">
                <span class="export-icon">🔧</span>
                <span>JSON Format</span>
                <small>Technical details</small>
            </button>
        </div>
    </div>
</div>
{% endblock %}